{% extends "admin/base.html" %}

{% block title %}Send Invoice - {{ booking.booking_number }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <h2 class="mb-4">Send Invoice via Xero</h2>
            
            <!-- Xero Connection Status -->
            {% if not xero_connected %}
            <div class="alert alert-warning mb-4" role="alert">
                <h5 class="alert-heading"><i class="fas fa-exclamation-triangle"></i> Xero Not Connected</h5>
                <p>You need to connect to Xero before you can send invoices.</p>
                <hr>
                <a href="{{ xero_auth_url }}" class="btn btn-primary">
                    <i class="fas fa-link"></i> Connect to Xero
                </a>
            </div>
            {% else %}
            <div class="alert alert-success mb-4" role="alert">
                <i class="fas fa-check-circle"></i> Xero is connected and ready to send invoices.
            </div>
            {% endif %}
            
            <!-- Booking Details Card -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5>Booking Details</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Booking Number:</strong> {{ booking.booking_number }}</p>
                            <p><strong>Customer:</strong> {{ booking.customer.first_name }} {{ booking.customer.last_name }}</p>
                            <p><strong>Email:</strong> {{ booking.customer.email }}</p>
                            <p><strong>Phone:</strong> {{ booking.customer.phone or 'N/A' }}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Vehicle:</strong> {{ booking.car.full_name if booking.car else 'N/A' }}</p>
                            <p><strong>Pickup Date:</strong> {{ booking.pickup_date.strftime('%Y-%m-%d %H:%M') if booking.pickup_date else 'N/A' }}</p>
                            <p><strong>Return Date:</strong> {{ booking.return_date.strftime('%Y-%m-%d %H:%M') if booking.return_date else 'N/A' }}</p>
                            <p><strong>Total Amount:</strong> ${{ "%.2f"|format(booking.total_amount) }}</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Invoice Form -->
            <div class="card">
                <div class="card-header">
                    <h5>Invoice Details</h5>
                </div>
                <div class="card-body">
                    <form id="invoiceForm">
                        <input type="hidden" id="bookingId" value="{{ booking.id }}">
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="invoiceAmount" class="form-label">Invoice Amount *</label>
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        <input type="number" 
                                               class="form-control" 
                                               id="invoiceAmount" 
                                               name="invoice_amount" 
                                               value="{{ booking.total_amount }}"
                                               step="0.01"
                                               min="0"
                                               required>
                                    </div>
                                    <small class="text-muted">Total amount from booking: ${{ "%.2f"|format(booking.total_amount) }}</small>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="dueDate" class="form-label">Due Date *</label>
                                    <input type="date" 
                                           class="form-control" 
                                           id="dueDate" 
                                           name="due_date" 
                                           required>
                                    <small class="text-muted">When should the invoice be paid?</small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Additional Services Summary -->
                        <div class="mb-3">
                            <label class="form-label">Services Included:</label>
                            <div class="border rounded p-3 bg-light">
                                <div class="row">
                                    <div class="col-md-6">
                                        <p class="mb-1"><strong>Base Rental:</strong> ${{ "%.2f"|format(booking.subtotal) }}</p>
                                        {% if booking.with_driver %}
                                        <p class="mb-1">✓ Driver Service</p>
                                        {% endif %}
                                        {% if booking.insurance_opted %}
                                        <p class="mb-1">✓ Insurance</p>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-6">
                                        {% if booking.gps_opted %}
                                        <p class="mb-1">✓ GPS Navigation</p>
                                        {% endif %}
                                        {% if booking.child_seat_opted %}
                                        <p class="mb-1">✓ Child Seat</p>
                                        {% endif %}
                                        {% if booking.additional_charges > 0 %}
                                        <p class="mb-1"><strong>Additional Charges:</strong> ${{ "%.2f"|format(booking.additional_charges) }}</p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="confirmDetails" required>
                                <label class="form-check-label" for="confirmDetails">
                                    I confirm that the customer details and invoice amount are correct
                                </label>
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-between">
                            <a href="{{ url_for('admin.bookings') }}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> Back to Bookings
                            </a>
                            <button type="submit" class="btn btn-primary" id="sendInvoiceBtn" {% if not xero_connected %}disabled{% endif %}>
                                <i class="fas fa-paper-plane"></i> Send Invoice
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Success Modal -->
<div class="modal fade" id="successModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">Invoice Sent Successfully</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center">
                    <i class="fas fa-check-circle text-success" style="font-size: 4rem;"></i>
                    <p class="mt-3">The invoice has been successfully created and sent to the customer.</p>
                    <p><strong>Invoice Number:</strong> <span id="invoiceNumber"></span></p>
                </div>
            </div>
            <div class="modal-footer">
                <a href="{{ url_for('bookings.view_booking', booking_id=booking.id) }}" class="btn btn-primary">
                    Back to Booking
                </a>
            </div>
        </div>
    </div>
</div>

<script>
// Set default due date to 7 days from today
document.addEventListener('DOMContentLoaded', function() {
    const dueDateInput = document.getElementById('dueDate');
    const today = new Date();
    const dueDate = new Date(today.setDate(today.getDate() + 7));
    dueDateInput.value = dueDate.toISOString().split('T')[0];
});

// Handle form submission
document.getElementById('invoiceForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const sendBtn = document.getElementById('sendInvoiceBtn');
    const originalBtnText = sendBtn.innerHTML;
    
    // Check if Xero is connected
    {% if not xero_connected %}
    alert('Please connect to Xero first before sending invoices.');
    return;
    {% endif %}
    
    // Disable button and show loading
    sendBtn.disabled = true;
    sendBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Sending...';
    
    const bookingId = document.getElementById('bookingId').value;
    
    try {
        const response = await fetch(`/admin/api/booking/${bookingId}/send-invoice`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Show success modal
            document.getElementById('invoiceNumber').textContent = result.invoice_number || 'N/A';
            const successModal = new bootstrap.Modal(document.getElementById('successModal'));
            successModal.show();
        } else if (result.needs_auth) {
            // Need to re-authorize
            if (confirm(result.message + '\n\nWould you like to reconnect to Xero now?')) {
                window.location.href = result.auth_url;
            } else {
                sendBtn.disabled = false;
                sendBtn.innerHTML = originalBtnText;
            }
        } else {
            // Show error message
            alert('Failed to send invoice: ' + (result.message || 'Unknown error'));
            sendBtn.disabled = false;
            sendBtn.innerHTML = originalBtnText;
        }
    } catch (error) {
        console.error('Error:', error);
        alert('An error occurred while sending the invoice. Please try again.');
        sendBtn.disabled = false;
        sendBtn.innerHTML = originalBtnText;
    }
});
</script>
{% endblock %}